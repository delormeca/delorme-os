---
description: "Backend exception handling, custom errors, and FastAPI error responses"
globs: app/core/exceptions.py,app/controllers/**
alwaysApply: false
---
# Backend Error Handling

## Custom Exceptions

```python
# app/core/exceptions.py
class BaseAppException(Exception):
    def __init__(self, message: str, error_code: str = None, details: dict = None):
        self.message = message
        self.error_code = error_code
        self.details = details or {}
        super().__init__(self.message)

class ValidationException(BaseAppException):
    pass

class NotFoundException(BaseAppException):
    pass

class AuthenticationException(BaseAppException):
    pass

class AuthorizationException(BaseAppException):
    pass
```

## Service Layer Pattern

```python
# Services raise specific exceptions
class ArticleService:
    async def get_article(self, article_id: int):
        article = await self.db.get(Article, article_id)
        if not article:
            raise NotFoundException(f"Article {article_id} not found")
        return article
    
    async def create_article(self, data: ArticleCreate):
        if len(data.title) < 3:
            raise ValidationException(
                "Title too short",
                error_code="TITLE_TOO_SHORT",
                details={"min_length": 3}
            )
        # ... create logic
```

## Controller Layer Pattern

```python
# Controllers convert exceptions to HTTP
@router.get("/{id}")
async def get_article(
    id: int,
    service: ArticleService = Depends(get_article_service),
):
    try:
        return await service.get_article(id)
    except NotFoundException as e:
        raise HTTPException(status_code=404, detail=e.message)
    except ValidationException as e:
        raise HTTPException(status_code=400, detail=e.message)
```

## Global Exception Handlers

```python
# main.py
from fastapi import Request
from fastapi.responses import JSONResponse
from app.core.exceptions import ValidationException, NotFoundException

@app.exception_handler(ValidationException)
async def validation_handler(request: Request, exc: ValidationException):
    return JSONResponse(
        status_code=400,
        content={
            "detail": exc.message,
            "type": "validation_error",
            "error_code": exc.error_code,
            "details": exc.details
        }
    )

@app.exception_handler(NotFoundException)
async def not_found_handler(request: Request, exc: NotFoundException):
    return JSONResponse(
        status_code=404,
        content={
            "detail": exc.message,
            "type": "not_found"
        }
    )
```

## Validation Errors

```python
# Return structured validation errors
from pydantic import ValidationError

@app.exception_handler(ValidationError)
async def validation_error_handler(request: Request, exc: ValidationError):
    return JSONResponse(
        status_code=422,
        content={
            "detail": "Validation failed",
            "errors": exc.errors()
        }
    )
```

## Error Response Format

All error responses follow this structure:
```json
{
  "detail": "Human-readable message",
  "type": "error_type",
  "error_code": "SPECIFIC_CODE",
  "details": {}
}
```

Follow these patterns for consistent error handling!
